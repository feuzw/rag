name: Deploy app to EC2 (Improved)

on:
  push:
    branches: [main]
    paths:
      - 'app/**'            # app í´ë” ë³€ê²½ì‹œì—ë§Œ ì‹¤í–‰
      - 'requirements.txt'  # requirements.txt ë³€ê²½ì‹œì—ë„ ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: app   # ëª¨ë“  run ëª…ë ¹ì´ app/ ê¸°ì¤€ìœ¼ë¡œ ì‹¤í–‰

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p "$HOME/.ssh"
          echo "${{ secrets.EC2_SSH_KEY }}" > "$HOME/.ssh/id_rsa"
          chmod 600 "$HOME/.ssh/id_rsa"
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> "$HOME/.ssh/known_hosts"

      - name: Deploy to EC2
        run: |
          # rsyncë¡œ app í´ë”ë§Œ EC2ì— ë™ê¸°í™”
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='venv' \
            . ubuntu@${{ secrets.EC2_HOST }}:/home/ubuntu/rag-app/

          # requirements.txtë„ ë³µì‚¬ (ë£¨íŠ¸ì— ìˆìœ¼ë©´)
          if [ -f "../requirements.txt" ]; then
            scp ../requirements.txt ubuntu@${{ secrets.EC2_HOST }}:/home/ubuntu/rag-app/
          fi

      - name: Setup and restart service on EC2
        run: |
          ssh ubuntu@${{ secrets.EC2_HOST }} << 'ENDSSH'
            cd ~/rag-app

            # ê°€ìƒí™˜ê²½ ìƒì„±/ì—…ë°ì´íŠ¸
            if [ ! -d "venv" ]; then
              python3 -m venv venv
            fi
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt

            # í™˜ê²½ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
            LLM_PROVIDER_VALUE="${{ secrets.LLM_PROVIDER }}"
            if [ -z "$LLM_PROVIDER_VALUE" ]; then
              LLM_PROVIDER_VALUE="openai"
            fi
            cat > .env << EOF
          POSTGRES_CONNECTION_STRING=${{ secrets.POSTGRES_CONNECTION_STRING }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          LLM_PROVIDER=${LLM_PROVIDER_VALUE}
          HOST=0.0.0.0
          PORT=8000
          RELOAD=false
          EOF
            chmod 600 .env

            # main.py ìˆ˜ì •: app.api_server -> api_server
            if [ -f "main.py" ]; then
              python3 << 'PYTHON_SCRIPT'
          import re
          with open('main.py', 'r', encoding='utf-8') as f:
              content = f.read()
          content = re.sub(r'"app\.api_server:app"', '"api_server:app"', content)
          content = re.sub(r"'app\.api_server:app'", "'api_server:app'", content)
          with open('main.py', 'w', encoding='utf-8') as f:
              f.write(content)
          print("âœ… main.py ìˆ˜ì • ì™„ë£Œ")
          PYTHON_SCRIPT
            fi

            # Systemd ì„œë¹„ìŠ¤ ì¬ì‹œì‘
            sudo systemctl restart rag-api || echo "âš ï¸ ì„œë¹„ìŠ¤ê°€ ì•„ì§ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."

            # í—¬ìŠ¤ ì²´í¬
            sleep 5
            if curl -f http://localhost:8000/health; then
              echo "âœ… ë°°í¬ ì„±ê³µ!"
            else
              echo "âŒ ë°°í¬ ì‹¤íŒ¨!"
              sudo journalctl -u rag-api -n 50
              exit 1
            fi
          ENDSSH

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ ë°°í¬ ì„±ê³µ!"
          else
            echo "âš ï¸ ë°°í¬ ì‹¤íŒ¨! ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
          fi

