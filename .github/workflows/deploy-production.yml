name: Deploy to EC2 (Production)

on:
  push:
    branches: [main]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2 (Production)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # í”„ë¡œë•ì…˜ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /opt/rag-app

            # ì½”ë“œ ì—…ë°ì´íŠ¸
            if [ -d ".git" ]; then
              git pull origin main
            else
              echo "âŒ ì˜¤ë¥˜: /opt/rag-appì— Git ì €ìž¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤."
              echo "   ë¨¼ì € ì´ˆê¸° ì„¤ì •ì„ ì‹¤í–‰í•˜ì„¸ìš”: scripts/setup_ec2_production.sh"
              exit 1
            fi

            # ì†Œìœ ê¶Œ í™•ì¸
            sudo chown -R $USER:$USER /opt/rag-app

            # ê°€ìƒí™˜ê²½ ìƒì„±/ì—…ë°ì´íŠ¸
            python3 -m venv venv
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r app/requirements.txt

            # í™˜ê²½ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
            cat > .env << EOF
POSTGRES_CONNECTION_STRING=${{ secrets.POSTGRES_CONNECTION_STRING }}
OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
LLM_PROVIDER=${{ secrets.LLM_PROVIDER }}
HOST=0.0.0.0
PORT=8000
RELOAD=false
EOF

            # .env íŒŒì¼ ê¶Œí•œ ì„¤ì • (ë³´ì•ˆ)
            chmod 600 .env

            # Systemd ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘
            sudo systemctl restart rag-api

            # ì„œë¹„ìŠ¤ ì‹œìž‘ ëŒ€ê¸°
            sleep 5

            # í—¬ìŠ¤ ì²´í¬
            if curl -f http://localhost:8000/health; then
              echo "âœ… ë°°í¬ ì„±ê³µ! ì„œë¹„ìŠ¤ê°€ ì •ìƒ ìž‘ë™ ì¤‘ìž…ë‹ˆë‹¤."
              echo "ðŸ“ ìœ„ì¹˜: /opt/rag-app"
            else
              echo "âŒ ë°°í¬ ì‹¤íŒ¨! ì„œë¹„ìŠ¤ê°€ ì‘ë‹µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
              sudo journalctl -u rag-api -n 50
              exit 1
            fi

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "ðŸŽ‰ í”„ë¡œë•ì…˜ ë°°í¬ ì„±ê³µ!"
            echo "ðŸ“ ë°°í¬ ìœ„ì¹˜: /opt/rag-app"
          else
            echo "âš ï¸ ë°°í¬ ì‹¤íŒ¨! ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
          fi

