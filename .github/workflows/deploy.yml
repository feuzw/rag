name: Deploy to EC2

on:
  push:
    branches: [main]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 15m
          script: |
            # í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (python3-venv)
            sudo apt-get update -qq
            sudo apt-get install -y -qq python3-venv git curl || true

            # ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p ~/rag-app
            cd ~/rag-app

            # Git ì €ì¥ì†Œê°€ ì´ë¯¸ ìˆìœ¼ë©´ pull, ì—†ìœ¼ë©´ clone
            if [ -d ".git" ]; then
              echo "ğŸ“¥ ê¸°ì¡´ ì €ì¥ì†Œì—ì„œ ì—…ë°ì´íŠ¸ ì¤‘..."
              git pull origin main || git pull origin master
            else
              echo "ğŸ“¥ ì €ì¥ì†Œ í´ë¡  ì¤‘..."
              git clone --depth 1 https://github.com/${{ github.repository }}.git .
            fi

            # ìµœì‹  ì½”ë“œë¡œ ì—…ë°ì´íŠ¸
            git fetch origin
            git reset --hard origin/main || git reset --hard origin/master

            # ê°€ìƒí™˜ê²½ ìƒì„±/ì—…ë°ì´íŠ¸
            if [ ! -d "venv" ] || [ ! -f "venv/bin/activate" ]; then
              echo "ğŸ“¦ ê°€ìƒí™˜ê²½ ìƒì„± ì¤‘..."
              python3 -m venv venv
              if [ ! -f "venv/bin/activate" ]; then
                echo "âš ï¸ venv ìƒì„± ì‹¤íŒ¨, python3-venv ì¬ì„¤ì¹˜ ì‹œë„"
                sudo apt-get install -y python3-venv
                python3 -m venv venv
                if [ ! -f "venv/bin/activate" ]; then
                  echo "âŒ venv ìƒì„± ì‹¤íŒ¨"
                  exit 1
                fi
              fi
              echo "âœ… ê°€ìƒí™˜ê²½ ìƒì„± ì™„ë£Œ"
            fi
            source venv/bin/activate || {
              echo "âŒ venv í™œì„±í™” ì‹¤íŒ¨"
              echo "   venv ë””ë ‰í† ë¦¬ í™•ì¸:"
              ls -la venv/ || echo "venv ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤"
              exit 1
            }
            pip install --upgrade pip
            pip install -r requirements.txt

            # í™˜ê²½ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
            LLM_PROVIDER_VALUE="${{ secrets.LLM_PROVIDER }}"
            if [ -z "$LLM_PROVIDER_VALUE" ]; then
              LLM_PROVIDER_VALUE="openai"
            fi
            echo "POSTGRES_CONNECTION_STRING=${{ secrets.POSTGRES_CONNECTION_STRING }}" > .env
            echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env
            echo "LLM_PROVIDER=${LLM_PROVIDER_VALUE}" >> .env
            echo "HOST=0.0.0.0" >> .env
            echo "PORT=8000" >> .env
            echo "RELOAD=false" >> .env
            # .env íŒŒì¼ ê¶Œí•œ ì„¤ì • (ë³´ì•ˆ)
            chmod 600 .env

            # Systemd ì„œë¹„ìŠ¤ ì¬ì‹œì‘ (ì—†ìœ¼ë©´ ê²½ê³ ë§Œ)
            if systemctl list-units --type=service --all | grep -q rag-api.service; then
              sudo systemctl restart rag-api
              sleep 5
              if curl -f http://localhost:8000/health; then
                echo "âœ… ë°°í¬ ì„±ê³µ! ì„œë¹„ìŠ¤ê°€ ì •ìƒ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤."
              else
                echo "âš ï¸ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨. ì„œë¹„ìŠ¤ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”."
                sudo journalctl -u rag-api -n 50 || true
                exit 1
              fi
            else
              echo "âš ï¸ Systemd ì„œë¹„ìŠ¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
              echo "   íŒŒì¼ ë°°í¬ëŠ” ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
              echo "   ì„œë¹„ìŠ¤ë¥¼ ì„¤ì •í•˜ë ¤ë©´: scripts/setup_systemd.sh ì‹¤í–‰"
              echo "âœ… íŒŒì¼ ë°°í¬ ì™„ë£Œ (ì„œë¹„ìŠ¤ ì„¤ì • í•„ìš”)"
            fi

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "ğŸ‰ ë°°í¬ ì„±ê³µ!"
          else
            echo "âš ï¸ ë°°í¬ ì‹¤íŒ¨! ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
          fi

