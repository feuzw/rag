name: Deploy to EC2

on:
  push:
    branches: [main]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 15m
          script: |
            # ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p ~/rag-app
            cd ~/rag-app

            # ìž„ì‹œ ë””ë ‰í† ë¦¬ì—ì„œ ì „ì²´ ì €ìž¥ì†Œ í´ë¡ 
            TEMP_DIR=$(mktemp -d)
            cd $TEMP_DIR
            git clone --depth 1 https://github.com/${{ github.repository }} temp-repo

            # app í´ë”ì™€ requirements.txtë§Œ ~/rag-appìœ¼ë¡œ ë³µì‚¬
            cp -r temp-repo/app/* ~/rag-app/
            cp temp-repo/requirements.txt ~/rag-app/ 2>/dev/null || echo "requirements.txtê°€ ë£¨íŠ¸ì— ì—†ìŠµë‹ˆë‹¤."

            # ì •ë¦¬
            cd ~
            rm -rf $TEMP_DIR

            # ~/rag-appìœ¼ë¡œ ì´ë™ (ì´ì œ app í´ë”ì˜ ë‚´ìš©ì´ ë£¨íŠ¸ì— ìžˆìŒ)
            cd ~/rag-app

            # main.py ìˆ˜ì •: app.api_server -> api_server (ë£¨íŠ¸ ë””ë ‰í† ë¦¬ ê¸°ì¤€)
            if [ -f "main.py" ]; then
              # sedë¥¼ ì‚¬ìš©í•˜ì—¬ ì•ˆì „í•˜ê²Œ ìˆ˜ì •
              sed -i 's/"app\.api_server:app"/"api_server:app"/g' main.py || true
              sed -i "s/'app\.api_server:app'/'api_server:app'/g" main.py || true
              echo "âœ… main.py ìˆ˜ì • ì™„ë£Œ"
            fi

            # ê°€ìƒí™˜ê²½ ìƒì„±/ì—…ë°ì´íŠ¸
            if [ ! -d "venv" ]; then
              python3 -m venv venv
            fi
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt

            # í™˜ê²½ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
            LLM_PROVIDER_VALUE="${{ secrets.LLM_PROVIDER }}"
            if [ -z "$LLM_PROVIDER_VALUE" ]; then
              LLM_PROVIDER_VALUE="openai"
            fi
            cat > .env << EOF
POSTGRES_CONNECTION_STRING=${{ secrets.POSTGRES_CONNECTION_STRING }}
OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
LLM_PROVIDER=${LLM_PROVIDER_VALUE}
HOST=0.0.0.0
PORT=8000
RELOAD=false
EOF
            # .env íŒŒì¼ ê¶Œí•œ ì„¤ì • (ë³´ì•ˆ)
            chmod 600 .env

            # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ë° ìž¬ì‹œìž‘ (Systemd ì‚¬ìš©)
            sudo systemctl restart rag-api || echo "âš ï¸ ì„œë¹„ìŠ¤ê°€ ì•„ì§ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”."

            # ì„œë¹„ìŠ¤ ì‹œìž‘ ëŒ€ê¸°
            sleep 5

            # í—¬ìŠ¤ ì²´í¬
            if curl -f http://localhost:8000/health; then
              echo "âœ… ë°°í¬ ì„±ê³µ! ì„œë¹„ìŠ¤ê°€ ì •ìƒ ìž‘ë™ ì¤‘ìž…ë‹ˆë‹¤."
            else
              echo "âš ï¸ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨. ì„œë¹„ìŠ¤ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”."
              sudo systemctl status rag-api || echo "ì„œë¹„ìŠ¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
              exit 1
            fi

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "ðŸŽ‰ ë°°í¬ ì„±ê³µ!"
          else
            echo "âš ï¸ ë°°í¬ ì‹¤íŒ¨! ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
          fi

