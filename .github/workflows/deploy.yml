name: Deploy to EC2

on:
  push:
    branches: [main]
  workflow_dispatch:  # 수동 실행 가능

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 15m
          script: |
            # 배포 디렉토리 생성
            mkdir -p ~/rag-app
            cd ~/rag-app

            # 임시 디렉토리에서 전체 저장소 클론
            TEMP_DIR=$(mktemp -d)
            cd $TEMP_DIR
            git clone --depth 1 https://github.com/${{ github.repository }} temp-repo

            # app 폴더와 requirements.txt만 ~/rag-app으로 복사
            cp -r temp-repo/app/* ~/rag-app/
            cp temp-repo/requirements.txt ~/rag-app/ 2>/dev/null || echo "requirements.txt가 루트에 없습니다."

            # 정리
            cd ~
            rm -rf $TEMP_DIR

            # ~/rag-app으로 이동 (이제 app 폴더의 내용이 루트에 있음)
            cd ~/rag-app

            # main.py 수정: app.api_server -> api_server (루트 디렉토리 기준)
            if [ -f "main.py" ]; then
              # Python 스크립트로 안전하게 수정
              python3 << 'PYTHON_SCRIPT'
import re

with open('main.py', 'r', encoding='utf-8') as f:
    content = f.read()

# app.api_server:app -> api_server:app로 변경
content = re.sub(r'"app\.api_server:app"', '"api_server:app"', content)
content = re.sub(r"'app\.api_server:app'", "'api_server:app'", content)

with open('main.py', 'w', encoding='utf-8') as f:
    f.write(content)

print("✅ main.py 수정 완료")
PYTHON_SCRIPT
            fi

            # 가상환경 생성/업데이트
            if [ ! -d "venv" ]; then
              python3 -m venv venv
            fi
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt

            # 환경 변수 업데이트
            LLM_PROVIDER_VALUE="${{ secrets.LLM_PROVIDER }}"
            if [ -z "$LLM_PROVIDER_VALUE" ]; then
              LLM_PROVIDER_VALUE="openai"
            fi
            cat > .env << EOF
POSTGRES_CONNECTION_STRING=${{ secrets.POSTGRES_CONNECTION_STRING }}
OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
LLM_PROVIDER=${LLM_PROVIDER_VALUE}
HOST=0.0.0.0
PORT=8000
RELOAD=false
EOF
            # .env 파일 권한 설정 (보안)
            chmod 600 .env

            # 기존 프로세스 종료 및 재시작 (Systemd 사용)
            sudo systemctl restart rag-api || echo "⚠️ 서비스가 아직 설정되지 않았습니다. 수동으로 설정하세요."

            # 서비스 시작 대기
            sleep 5

            # 헬스 체크
            if curl -f http://localhost:8000/health; then
              echo "✅ 배포 성공! 서비스가 정상 작동 중입니다."
            else
              echo "⚠️ 헬스 체크 실패. 서비스 상태를 확인하세요."
              sudo systemctl status rag-api || echo "서비스가 설정되지 않았습니다."
              exit 1
            fi

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "🎉 배포 성공!"
          else
            echo "⚠️ 배포 실패! 로그를 확인하세요."
          fi

